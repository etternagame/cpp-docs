<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Etterna: `InputHandler_SextetStream_*`</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Etterna
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">`InputHandler_SextetStream_*` </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Explanation </h2>
<p>This is a set of drivers (currently, just one driver) that accept button inputs encoded in a stream of character. By accepting this data from a stream, input can be produced by a separate program. Such a program can be implemented using any language/platform that supports reading from the desired input device (and writing to an output stream). If C++ isn't your thing, or if learning the guts of <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> seems a little much just to implement an input driver, you're in the right place.</p>
<h2>Quick start </h2>
<p>You'll need a working <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> build with the driver <code><a class="el" href="../../d0/d30/classInputHandler__SextetStreamFromFile.html">InputHandler_SextetStreamFromFile</a></code> enabled.</p>
<p>For this test, you'll run a test input program to verify that the driver is set up properly. This is a simple example of an <em>input program</em>, a program that will receive input from some arbitrary input source, encode the button states, and produce output to be read by <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a>. Because this script is for testing and diagnostics, input is accepted as keypresses on a GUI window. Actual input programs produce output in the same way, but will read input from different sources, such as data from a hardware interface (serial/parallel/USB).</p>
<h3>Set up <code>SextetStreamStdoutTest.jar</code></h3>
<p>You'll need the test input program, <a href="https://github.com/psmay/SextetStreamStdoutTest/releases"><code>SextetStreamStdoutTest.jar</code></a>, as well as a working Java VM to run it. To ensure that the current environment is correct, simply run the program: </p><pre class="fragment">java -jar SextetStreamStdoutTest.jar
</pre><p>A GUI window should open. Click on this window and then try pressing some keys. When one of these keys is pressed, its code (number) appears; when released, the code disappears.</p>
<p>The output of this program on your console is the encoded sextets representing the state of the pressed keys. A new output line is produced immediately when a button is either pressed or released. An output line is also produced periodically (about once per second) if there have been no recent changes so that the driver is never left blocking for too long an interval.</p>
<p>Each output line is only as long as necessary to express the current state. While nothing is pressed, the output should be this line, about once per second: </p><pre class="fragment">@
</pre><p>Press and hold the up arrow. The output should be this line, again about once per second: </p><pre class="fragment">@@@@@@D
</pre><p>If instead you get a rapidly scrolling alternation like </p><pre class="fragment">@@@@@@D
@
@@@@@@D
@
@@@@@@D
@
@@@@@@D
@
</pre><p>you should use your OS or window system settings to disable key repeat, at least for the duration of the test, to avoid an undesired rapid-fire effect.</p>
<h3>Linux</h3>
<p>We assume that <code>SextetStreamStdoutTest.jar</code> is working (as outlined above) and that <code>$SM</code> is the root <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> directory.</p>
<p>In <code>Preferences.ini</code>, set: </p><pre class="fragment">InputDrivers=X11,SextetStreamFromFile
SextetStreamInputFilename=Data/StepMania-Input-SextetStream.in
</pre><p>(This also keeps X11-based keyboard input enabled. The X11 part can be removed later after setting up input mappings, if desired.)</p>
<p>Create the FIFO: </p><pre class="fragment">mkfifo "$SM/Data/StepMania-Input-SextetStream.in"
</pre><p>Run the test input program using the FIFO as output: </p><pre class="fragment">java -jar SextetStreamStdoutTest.jar &gt; "$SM/Data/StepMania-Input-SextetStream.in"
</pre><p>While the input program is running, start <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a>. (While using the test program, use windowed mode to keep both <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> and the input program visible.) Using the keyboard directly on the <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> window, go to Options, Test Input. Switch to the test input program and try pressing some keys. If <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> displays corresponding messages, the driver is working properly.</p>
<h4>Serial port under Linux</h4>
<p>FIXME: <em>This has not been tested at all.</em> The following is a guess at a synopsis of how it should work if you're lucky enough for everything to have fallen into place just so. (Please amend this message if you manage to get this running consistently.)</p>
<p>If you have a microcontroller running firmware that produces output compatible with the SextetStream protocol, you can use <code>socat</code> as the input program to pipe the data directly from the device via a serial port: </p><pre class="fragment">socat /dev/ttyUSB0,raw,echo=0,b115200 "$SM/Data/StepMania-Input-SextetStream.in"
</pre><p>Substitute your actual serial port device for <code>/dev/ttyUSB0</code> and the actual port speed for <code>115200</code>. (A low speed will not freeze <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a>, but may introduce an unacceptable input latency.)</p>
<p>TODO: Supply example Arduino/PIC/... firmware.</p>
<p>TODO: Supply example of full-duplex in cooperation with the SextetStream lights driver.</p>
<h3>Mac OS X</h3>
<p>FIXME: <em>This has not been tested at all.</em> The following is a guess at a synopsis of how it should work if you're lucky enough for everything to have fallen into place just so. (Please amend this message if you manage to get this running consistently on Mac OS X.)</p>
<p>Follow the instructions for Linux, but change the <code>InputDrivers</code> setting to: </p><pre class="fragment">InputDrivers=HID,SextetStreamFromFile
</pre><p>(This also keeps the default HID-based input enabled. The HID part can be removed later after setting up input mappings, if desired.)</p>
<p>TODO: Serial examples.</p>
<h3>Windows</h3>
<p>FIXME: <em>This has not been tested at all.</em> The following is a guess at a synopsis of how it should work if you're lucky enough for everything to have fallen into place just so. (Please amend this message if you manage to get this running consistently on Windows.)</p>
<p>We assume that <code>SextetStreamStdoutTest.jar</code> is working (as outlined above). You will also need <a href="https://github.com/psmay/windows-named-pipe-utils/releases"><code>createAndWritePipe</code></a> to be able to work with a named pipe from the console.</p>
<p>In <code>Preferences.ini</code>, set: </p><pre class="fragment">InputDrivers=DirectInput,SextetStreamFromFile
SextetStreamInputFilename=\\.\pipe\StepMania-Input-SextetStream
</pre><p>(This also keeps the default DirectInput-based input enabled. The DirectInput part can be removed later after setting up input mappings, if desired.)</p>
<p>Run the input program and use <code>createAndWritePipe</code> to redirect the output into the named pipe: </p><pre class="fragment">java -jar SextetStreamStdoutTest.jar | createAndWritePipe StepMania-Input-SextetStream
</pre><p>While the input program is running, start <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a>. (While using the test program, use windowed mode to keep both <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> and the input program visible.) Using the keyboard directly on the <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> window, go to Options, Test Input. Switch to the test input program and try pressing some keys. If <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> displays corresponding messages, the driver is working properly.</p>
<p>TODO: Serial examples.</p>
<h2>Keyboard-based demo limitations </h2>
<p>Due to the design of some keyboards and/or their drivers, the number of keys that can be held at one time, which keys can be pressed simultaneously, and which keys have priority over others may vary. The SextetStream driver itself has no such limitation and can process all buttons independently of each other if the input program is capable of providing such information.</p>
<h2>Encoding </h2>
<h3>Packing sextets</h3>
<p>Values are encoded six bits at a time (hence "sextet"). The characters are made printable, non-whitespace ASCII so that attempting to read the data or pass it through a text-oriented channel will not cause problems. The encoding is similar in concept to base64 or uuencode, but in this scheme the low 6 bits remain unchanged.</p>
<p>Data is packed into the low 6 bits of a byte, then the two high bits are set in such a way that the result is printable, non-whitespace ASCII: </p><pre class="fragment">0x00-0x0F -&gt; 0x40-0x4F
0x10-0x1F -&gt; 0x50-0x5F
0x20-0x2F -&gt; 0x60-0x6F
0x30-0x3F -&gt; 0x30-0x3F
</pre><p>(0x20-0x2F and 0x70-0x7F are avoided since they contain control or whitespace characters.)</p>
<p>To encode a 6-bit value <code>s</code> in this way, this transform may be used: </p><pre class="fragment">((s + 0x10) &amp; 0x3F) + 0x30
</pre><h3>Bit meanings</h3>
<p>This driver produces events for a virtual game controller with no axes and an arbitrary number of buttons. As with an actual gamepad, the in-game meaning of each button can be configured in <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a>.</p>
<p>Note that the maximum number of gamepad buttons supported by <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> is currently 32. Higher codes are coded as keypresses for unknown keys (which is unusual for a game controller, but works here).</p>
<ul>
<li>Byte 0<ul>
<li>0x01 button B1</li>
<li>0x02 button B2</li>
<li>0x04 button B3</li>
<li>0x08 button B4</li>
<li>0x10 button B5</li>
<li>0x20 button B6</li>
</ul>
</li>
<li>…</li>
<li>Byte <code>n</code> for <code>n &lt; 5</code><ul>
<li>0x01 button B<code>6n+1</code></li>
<li>0x02 button B<code>6n+2</code></li>
<li>0x04 button B<code>6n+3</code></li>
<li>0x08 button B<code>6n+4</code></li>
<li>0x10 button B<code>6n+5</code></li>
<li>0x20 button B<code>6n+6</code></li>
</ul>
</li>
<li>…</li>
<li>Byte 5<ul>
<li>0x01 button B31</li>
<li>0x02 button B32</li>
<li>0x04 key unk 0</li>
<li>0x08 key unk 1</li>
<li>0x10 key unk 2</li>
<li>0x20 key unk 3</li>
</ul>
</li>
<li>…</li>
<li>Byte <code>n</code> for <code>n &gt; 5</code><ul>
<li>0x01 key unk <code>6(n-6)+4</code></li>
<li>0x02 key unk <code>6(n-6)+5</code></li>
<li>0x04 key unk <code>6(n-6)+6</code></li>
<li>0x08 key unk <code>6(n-6)+7</code></li>
<li>0x10 key unk <code>6(n-6)+8</code></li>
<li>0x20 key unk <code>6(n-6)+9</code></li>
</ul>
</li>
</ul>
<p>A message is ended by terminating it with LF (0x0A) or CR LF (0x0D 0x0A). Data bytes outside 0x30-0x6F are discarded. The message can be as large or as short as necessary, to encode all buttons. Any buttons not encoded in a message are understood to have the value 0.</p>
<p>These messages both indicate that buttons 4 and 6 are pressed, and all others are not: </p><pre class="fragment"># Note: 0x68 &amp; 0x3F == 0x28; 0x40 &amp; 0x3F == 0x00
0x68 0x40 0x40 0x0A
0x68 0x0A
</pre><p>The number of buttons supported by the implementation is currently the number of supported joy buttons plus the number of supported unknown keys (as of this writing: 32 + 321 = 353; you certainly shouldn't need this many). Overlong input lines are allowed and truncated. Because the number of bytes needed in an input line is proportional to the index of the highest-indexed bit currently in an on state, it's probably a good idea to keep that number low whenever possible, especially when using a low-speed input (such as a serial or network connection).</p>
<h2>Filesystem </h2>
<p>The current implementation of this driver uses C standard I/O (i.e., <code>fopen()</code>, <code>fread()</code>, etc.) instead of the <code><a class="el" href="../../dd/d5e/classRageFile.html" title="High-level file access. ">RageFile</a></code> abstraction Therefore, any <code><a class="el" href="../../dd/d5e/classRageFile.html" title="High-level file access. ">RageFile</a></code>-based filesystem abstractions <em>are not</em> applied. Please keep this in mind when specifying the input path.</p>
<p>FIXME: This behavior is definitely subject to change should the following problem ever get worked out: I was unable to get <code><a class="el" href="../../dd/d5e/classRageFile.html" title="High-level file access. ">RageFile</a></code> to work in this context; I believe the cause is that I couldn't get a <code><a class="el" href="../../dd/d5e/classRageFile.html" title="High-level file access. ">RageFile</a></code> object to do unbuffered input. It may have been something else.</p>
<h2>Pipes </h2>
<p>The input of this driver is streamed from a file. At face value, this is not too useful. The actual intent is for the system operator to create a <em>named fifo</em> or <em>named pipe</em> that is being written to by some already running program, such as a program that reads button state data in over a serial connection. It just happens that opening a named fifo for reading can be accomplished in the same fashion as opening a file for reading, as long as buffering can be disabled. Since there's an easy, platform-ignorant way to do that, that's what we've done.</p>
<h3>Blocking behavior</h3>
<p>This driver uses blocking I/O, but does so in a separate thread so that <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> will read lines about as fast as they are written and there is no technical minimum data rate. However, the blocking read temporarily</p>
<p>particular, as <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> exits, it may hang waiting for the input thread to finish until one of the following happens:</p>
<ul>
<li>The input program closes the stream</li>
<li>The input program outputs a line, allowing <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> to end the input thread</li>
</ul>
<p>So, for the purposes of this driver, it is good manners for an input program to periodically (e.g. once per second) repeat its current state so that the input thread is never left blocking for too long at a time. (Alternatively, if the input program has some way to determine that <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> is exiting, it may just close the stream instead.)</p>
<h3>Linux (and some other unixish systems)</h3>
<p><code>mkfifo</code> is used to create a named FIFO. After this is done, two programs (one reading and one writing) open the FIFO as if it were some ordinary file and use ordinary file I/O to read or write.</p>
<p>For this driver, the input program and <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> open the file for write and read, respectively.</p>
<p>Input programs producing output on stdout work trivially; the program's output is simply redirected to the FIFO.</p>
<h3>Windows</h3>
<p>The client side of a Windows named pipe is fairly ordinary; the path to an already-open pipe can be opened and used as if it were an ordinary file. For this driver, <a class="el" href="../../de/d6f/namespaceStepMania.html" title="Utility functions for controlling the whole game. ">StepMania</a> is the client.</p>
<p>The server side of the pipe is a little trickier. Special Windows API calls are needed to create the pipe and then wait for the client to connect. Unlike in Linux, the FIFO goes away when it is closed. For this driver, the input program is the server.</p>
<p>Input programs producing output on stdout do not work trivially because named pipes are not eligible to be created or redirected to on the command line. Such a program can be redirected to a bridging program such as <code>createAndWritePipe</code>, which creates a pipe and then relays whatever is received on stdin to the pipe.</p>
<p>A Windows-specific input program might also just create and write a named pipe by itself.</p>
<h1>License </h1>
<p>Copyright © 2014 Peter S. May</p>
<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>
<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="../../doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
